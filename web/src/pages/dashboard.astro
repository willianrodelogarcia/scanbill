---
import Layout from '../layouts/Layout.astro';
export const prerender = false;

const api_url = import.meta.env.API_URL;

const res = await fetch(`${api_url}/api/login/validate`, {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    cookie: Astro.request.headers.get('cookie') || '',
  },
  credentials: 'include',
});

let user = null;
if (res.ok) {
  const data = await res.json();
  user = data.user;
} else {
  return Astro.redirect('/');
}
---

<Layout>
  <div
    class="bg-white p-8 rounded-xl shadow-md w-full max-w-md text-center flex items-center justify-center min-h-screen"
  >
    <h1 class="text-2xl font-bold mb-6">Bienvenido, {user.username}</h1>

    <form method="POST" action="/api/logout">
      <button
        type="submit"
        class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors"
      >
        Cerrar sesi贸n
      </button>
    </form>
  </div>
  <script>
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/api/logout', {
            method: 'POST',
          });

          if (res.redirected) {
            window.location.href = res.url;
          } else {
            alert('No se pudo cerrar sesi贸n');
          }
        } catch (err) {
          console.error('Error al cerrar sesi贸n:', err);
          alert('Ocurri贸 un error');
        }
      });
    }
  </script>
</Layout>
